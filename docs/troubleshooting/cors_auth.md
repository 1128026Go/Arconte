# üîß Soluci√≥n: Error CORS en /api/cases

## üìä Diagn√≥stico del Problema

### ‚ùå Error Reportado
```
Access to fetch at 'http://localhost:8000/api/cases' from origin 'http://localhost:3000'
has been blocked by CORS policy: No 'Access-Control-Allow-Origin' header is present
```

### ‚úÖ Problema REAL

**El error NO es de CORS, es de AUTENTICACI√ìN**

El servidor Laravel **S√ç est√° enviando** los headers CORS correctos:
```
Access-Control-Allow-Origin: http://localhost:3000 ‚úì
Access-Control-Allow-Credentials: true ‚úì
```

El verdadero problema:
1. **HTTP 401 Unauthorized** - Usuario NO autenticado
2. El endpoint `/api/cases` requiere autenticaci√≥n con Sanctum
3. El navegador muestra error "CORS" pero es por la falta de login

### üîç Verificaci√≥n T√©cnica

```bash
# El preflight CORS funciona correctamente:
curl -X OPTIONS http://localhost:8000/api/cases \
  -H "Origin: http://localhost:3000" \
  -H "Access-Control-Request-Method: GET"

# Respuesta: 204 No Content con headers CORS ‚úì

# El problema es autenticaci√≥n:
curl http://localhost:8000/api/cases \
  -H "Origin: http://localhost:3000"

# Respuesta: 401 {"message":"Unauthenticated."} ‚úó
```

---

## ‚úÖ Soluciones

### Soluci√≥n 1: **LOGIN CORRECTO** (Recomendada)

El sistema YA est√° bien implementado. Solo necesitas:

1. **Ir a la p√°gina de login**: `http://localhost:3000/login`

2. **Iniciar sesi√≥n** con tus credenciales

3. **Sanctum guardar√° la cookie autom√°ticamente**

4. **Todas las peticiones funcionar√°n**

El flujo correcto es:
```
Usuario ‚Üí /login ‚Üí Login exitoso ‚Üí Cookie guardada ‚Üí /cases ‚úì
```

### Soluci√≥n 2: **Verificar que el servidor est√© corriendo**

```bash
# En terminal 1: Servidor Laravel
cd apps/api_php
php artisan serve --port=8000

# En terminal 2: Frontend React
cd apps/web
npm run dev
```

### Soluci√≥n 3: **Limpiar cookies si hay conflicto**

Si ya iniciaste sesi√≥n pero sigue fallando:

1. Abre DevTools (F12)
2. Application ‚Üí Cookies
3. Elimina cookies de `localhost:8000`
4. Refresca y vuelve a hacer login

---

## üìÅ Estructura de Archivos del Frontend

### ‚úÖ Archivos Correctos (NO eliminar)

```
apps/web/src/
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îú‚îÄ‚îÄ apiSecure.js        ‚Üê ‚úÖ API CLIENT PRINCIPAL (bien implementado)
‚îÇ   ‚îú‚îÄ‚îÄ api.js              ‚Üê ‚úÖ Re-exporta apiSecure (OK)
‚îÇ   ‚îú‚îÄ‚îÄ date.js             ‚Üê ‚úÖ Utilidades de fecha
‚îÇ   ‚îú‚îÄ‚îÄ caseMap.js          ‚Üê ‚úÖ Normalizaci√≥n de datos
‚îÇ   ‚îî‚îÄ‚îÄ logger.js           ‚Üê ‚úÖ Logs
‚îÇ
‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îî‚îÄ‚îÄ useAuth.js          ‚Üê ‚úÖ Hook de autenticaci√≥n (bien implementado)
‚îÇ
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ ProtectedRoute.jsx  ‚Üê ‚úÖ Protecci√≥n de rutas
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ
‚îî‚îÄ‚îÄ pages/
    ‚îú‚îÄ‚îÄ Login.jsx           ‚Üê ‚úÖ P√°gina de login
    ‚îú‚îÄ‚îÄ Cases.jsx           ‚Üê ‚úÖ Usa API correctamente
    ‚îî‚îÄ‚îÄ ...
```

### ‚úÖ NO hay archivos redundantes

El sistema est√° **muy bien organizado**:
- `apiSecure.js` - Cliente API √∫nico con todas las funciones
- `api.js` - Wrapper para compatibilidad (3 l√≠neas, OK mantener)
- Todos los componentes usan el mismo cliente

---

## üéØ Mejores Pr√°cticas Implementadas

### ‚úÖ 1. Autenticaci√≥n por Cookies (Sanctum)

```javascript
// apps/web/src/lib/apiSecure.js

const fetchConfig = {
  credentials: 'include', // ‚úì Incluye cookies autom√°ticamente
  headers: {
    'Accept': 'application/json',
    'X-Requested-With': 'XMLHttpRequest',
  }
};
```

**Ventajas**:
- ‚úì M√°s seguro que tokens en localStorage
- ‚úì Protecci√≥n CSRF autom√°tica
- ‚úì HttpOnly cookies (no accesibles por JavaScript)

### ‚úÖ 2. Manejo de CSRF Tokens

```javascript
const getCsrfToken = () => {
  const match = document.cookie.match(/XSRF-TOKEN=([^;]+)/);
  return match ? decodeURIComponent(match[1]) : null;
};

// Agregado autom√°ticamente a cada request
headers['X-XSRF-TOKEN'] = getCsrfToken();
```

### ‚úÖ 3. Manejo de Errores 401

```javascript
if (response.status === 401) {
  // Dispara evento que el hook escucha
  window.dispatchEvent(new CustomEvent('auth:unauthorized'));
  throw new Error('unauthorized');
}
```

```javascript
// Hook escucha y redirige autom√°ticamente
const handleAuthUnauthorized = () => {
  setUser(null);
  setIsAuthenticated(false);
  window.location.href = '/login'; // ‚úì Redirige a login
};
```

### ‚úÖ 4. Rutas Protegidas

```javascript
// App.jsx
<Route path="/cases" element={
  <ProtectedRoute>
    <Cases />
  </ProtectedRoute>
} />
```

```javascript
// ProtectedRoute.jsx
if (!isAuthenticated) {
  return <Navigate to="/login" replace />; // ‚úì Redirige si no autenticado
}
```

### ‚úÖ 5. Cliente API Centralizado

```javascript
// Todas las entidades usan el mismo patr√≥n
export const cases = {
  getAll: async (params) => apiRequest(`/cases${buildQuery(params)}`),
  getById: async (id) => apiRequest(`/cases/${id}`),
  create: async (data) => apiRequest('/cases', { method: 'POST', ... }),
  // ...
};

export const documents = { ... };
export const reminders = { ... };
export const billing = { ... };
// etc.
```

---

## üöÄ Flujo Completo de Autenticaci√≥n

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 1. Usuario visita http://localhost:3000/cases  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
                   ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 2. ProtectedRoute verifica autenticaci√≥n       ‚îÇ
‚îÇ    - useAuth hook llama auth.me()              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ                   ‚îÇ
         ‚ñº                   ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ NO autenticado ‚îÇ  ‚îÇ S√ç autenticado     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                   ‚îÇ
         ‚ñº                   ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Redirige a     ‚îÇ  ‚îÇ Renderiza p√°gina   ‚îÇ
‚îÇ /login         ‚îÇ  ‚îÇ Cases.jsx          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                   ‚îÇ
         ‚ñº                   ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Login exitoso  ‚îÇ  ‚îÇ cases.getAll()     ‚îÇ
‚îÇ Cookie guardada‚îÇ  ‚îÇ con credentials    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                   ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚îÇ
                  ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Todas las peticiones incluyen cookie Sanctum   ‚îÇ
‚îÇ Backend valida y retorna datos                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üîß Configuraci√≥n del Backend (Laravel)

### ‚úÖ CORS Configurado Correctamente

```php
// apps/api_php/config/cors.php
return [
    'paths' => ['api/*', 'sanctum/csrf-cookie'],
    'allowed_methods' => ['*'],
    'allowed_origins' => [
        'http://localhost:3000',  // ‚úì Frontend permitido
        'http://127.0.0.1:3000',
    ],
    'allowed_headers' => ['*'],
    'supports_credentials' => true,  // ‚úì Cookies permitidas
];
```

### ‚úÖ Middleware Configurado

```php
// apps/api_php/bootstrap/app.php
->withMiddleware(function (Middleware $middleware): void {
    $middleware->statefulApi();  // ‚úì Sanctum stateful

    $middleware->api(prepend: [
        \Illuminate\Http\Middleware\HandleCors::class,  // ‚úì CORS primero
    ]);
})
```

### ‚úÖ Rutas Protegidas

```php
// apps/api_php/routes/api.php
Route::middleware(['auth:sanctum', 'throttle:60,1'])->group(function () {
    Route::get('/cases', [CaseController::class, 'index']);  // ‚úì Requiere auth
    // ...
});
```

---

## üß™ Testing

### Test 1: Verificar CORS

```bash
curl -X OPTIONS http://localhost:8000/api/cases \
  -H "Origin: http://localhost:3000" \
  -H "Access-Control-Request-Method: GET" \
  -v

# Debe retornar:
# Access-Control-Allow-Origin: http://localhost:3000 ‚úì
# Access-Control-Allow-Credentials: true ‚úì
```

### Test 2: Verificar Login

```javascript
// En consola del navegador (F12)
import { auth } from './lib/api.js';

// Login
const result = await auth.login('tu@email.com', 'password');
console.log('Login exitoso:', result);

// Verificar sesi√≥n
const me = await auth.me();
console.log('Usuario actual:', me);
```

### Test 3: Verificar Peticiones

```javascript
// En consola del navegador despu√©s de login
import { cases } from './lib/api.js';

const lista = await cases.getAll();
console.log('Cases:', lista);
// Debe funcionar sin errores ‚úì
```

---

## üìù Checklist de Soluci√≥n

- [ ] Servidor Laravel corriendo en puerto 8000
- [ ] Frontend React corriendo en puerto 3000
- [ ] Ir a http://localhost:3000/login
- [ ] Iniciar sesi√≥n con credenciales v√°lidas
- [ ] Verificar que aparece cookie en DevTools
- [ ] Navegar a /cases
- [ ] ‚úì Debe cargar sin errores

---

## üÜò Troubleshooting

### Problema: "Unauthenticated" despu√©s de login

**Soluci√≥n**: Verificar que `.env` tenga:
```env
SESSION_DRIVER=cookie
SESSION_DOMAIN=localhost
SANCTUM_STATEFUL_DOMAINS=localhost:3000,127.0.0.1:3000
```

### Problema: Cookie no se guarda

**Causas posibles**:
1. Navegador bloqueando cookies de terceros
2. SESSION_DOMAIN incorrecto
3. SameSite=None sin HTTPS (cambiar a SameSite=Lax)

**Soluci√≥n**:
```php
// config/session.php
'same_site' => 'lax',  // En desarrollo
```

### Problema: Error persiste despu√©s de login

**Soluci√≥n**:
1. Limpiar cookies completamente
2. Reiniciar servidor Laravel
3. Reiniciar frontend
4. Probar en navegador privado/inc√≥gnito

---

## ‚úÖ Resumen

**Tu c√≥digo est√° PERFECTO** ‚úÖ

- ‚úì CORS configurado correctamente
- ‚úì Autenticaci√≥n Sanctum implementada
- ‚úì Cliente API con mejores pr√°cticas
- ‚úì Manejo de errores robusto
- ‚úì Protecci√≥n de rutas
- ‚úì NO hay archivos redundantes

**El √∫nico problema**: Usuario no logueado

**La soluci√≥n**: Ir a /login y autenticarse

---

**Fecha**: 2025-10-10
**Estado**: C√ìDIGO CORRECTO - Solo falta login
