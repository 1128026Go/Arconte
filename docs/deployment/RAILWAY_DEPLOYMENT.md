# üöÇ Deployment en Railway - Arconte

Railway es una plataforma PaaS (Platform as a Service) que facilita el deployment de aplicaciones con Docker. Ideal para MVPs, startups y deployment r√°pido.

---

## üìã Tabla de Contenidos

1. [Ventajas y Limitaciones](#ventajas-y-limitaciones)
2. [Requisitos](#requisitos)
3. [Preparaci√≥n del Proyecto](#preparaci√≥n-del-proyecto)
4. [Deployment Paso a Paso](#deployment-paso-a-paso)
5. [Configuraci√≥n Avanzada](#configuraci√≥n-avanzada)
6. [Troubleshooting](#troubleshooting)

---

## ‚úÖ Ventajas y Limitaciones

### ‚úÖ Ventajas

- ‚úÖ **Deploy en 15 minutos** desde GitHub
- ‚úÖ **Auto-scaling** incluido
- ‚úÖ **HTTPS autom√°tico** (certificados SSL gratis)
- ‚úÖ **PostgreSQL incluido** (base de datos gestionada)
- ‚úÖ **Redis incluido** (opcional)
- ‚úÖ **CI/CD autom√°tico** (push ‚Üí deploy)
- ‚úÖ **Logs centralizados**
- ‚úÖ **Backups autom√°ticos** de DB
- ‚úÖ **Variables de entorno** f√°ciles de gestionar
- ‚úÖ **No requiere DevOps** knowledge

### ‚ö†Ô∏è Limitaciones

- ‚ö†Ô∏è **Costo m√°s alto** que VPS (~$20-50/mes vs $5-20/mes)
- ‚ö†Ô∏è **Menos control** sobre infraestructura
- ‚ö†Ô∏è **Dependencia de plataforma** (vendor lock-in)
- ‚ö†Ô∏è **L√≠mites de recursos** en planes b√°sicos
- ‚ö†Ô∏è **No ideal para tr√°fico muy alto** (mejor VPS/Kubernetes)

### üí∞ Pricing Estimado

**Starter Plan (Recomendado):**
- PostgreSQL: $5-10/mes
- Redis: $5/mes
- Backend: $10-20/mes (seg√∫n recursos)
- Frontend: $5/mes
- **Total:** ~$25-40/mes

**Trial:** $5 gratis de cr√©dito para probar

---

## üìã Requisitos

### Previos

- [ ] Cuenta de GitHub con el repositorio de Arconte
- [ ] Cuenta de Railway: https://railway.app (sign up con GitHub)
- [ ] Dominio registrado (opcional pero recomendado)
- [ ] Cuenta de Cloudflare (para DNS, opcional)

### APIs Externas

- [ ] Gemini API Key: https://makersuite.google.com/app/apikey
- [ ] ePayco Keys: https://dashboard.epayco.co
- [ ] Resend API Key: https://resend.com/api-keys

---

## üîß Preparaci√≥n del Proyecto

### Paso 1: Ajustar Estructura para Railway

Railway necesita archivos de configuraci√≥n espec√≠ficos en la ra√≠z.

**1.1. Crear railway.json (Configuraci√≥n Railway)**

```bash
cd "Aplicacion Juridica"
nano railway.json
```

Agregar:

```json
{
  "$schema": "https://railway.app/railway.schema.json",
  "build": {
    "builder": "DOCKERFILE",
    "dockerfilePath": "Dockerfile.railway"
  },
  "deploy": {
    "numReplicas": 1,
    "restartPolicyType": "ON_FAILURE",
    "restartPolicyMaxRetries": 10
  }
}
```

**1.2. Crear Dockerfile.railway (Multi-service)**

Railway prefiere un solo Dockerfile que maneje todo:

```dockerfile
# Dockerfile.railway
# Multi-stage build para Railway

ARG SERVICE_NAME=api

# ============================================
# Stage 1: Backend Builder
# ============================================
FROM php:8.2-fpm-alpine AS backend-builder

RUN apk add --no-cache \
    git curl libpng-dev libzip-dev zip unzip \
    postgresql-dev oniguruma-dev

RUN docker-php-ext-install \
    pdo_pgsql pgsql mbstring zip exif pcntl bcmath gd

COPY --from=composer:latest /usr/bin/composer /usr/bin/composer

WORKDIR /var/www/html

COPY apps/api_php/composer.json apps/api_php/composer.lock ./
RUN composer install --no-dev --optimize-autoloader --no-interaction

COPY apps/api_php .

RUN chown -R www-data:www-data /var/www/html \
    && chmod -R 755 /var/www/html/storage

# ============================================
# Stage 2: Frontend Builder
# ============================================
FROM node:20-alpine AS frontend-builder

WORKDIR /app

COPY apps/web/package*.json ./
RUN npm ci --only=production

COPY apps/web .
RUN npm run build

# ============================================
# Stage 3: Backend Runtime
# ============================================
FROM php:8.2-fpm-alpine AS backend

RUN apk add --no-cache libpng libzip postgresql-libs oniguruma nginx supervisor

RUN apk add --no-cache --virtual .build-deps \
    libpng-dev libzip-dev postgresql-dev oniguruma-dev \
    && docker-php-ext-install \
    pdo_pgsql pgsql mbstring zip exif pcntl bcmath gd \
    && apk del .build-deps

WORKDIR /var/www/html

COPY --from=backend-builder --chown=www-data:www-data /var/www/html /var/www/html
COPY apps/api_php/docker/php/php-fpm.conf /usr/local/etc/php-fpm.d/www.conf
COPY apps/api_php/docker/php/php.ini /usr/local/etc/php/php.ini
COPY apps/api_php/docker/nginx/nginx.conf /etc/nginx/nginx.conf
COPY apps/api_php/docker/nginx/default.conf /etc/nginx/http.d/default.conf
COPY apps/api_php/docker/supervisor/supervisord.conf /etc/supervisord.conf

RUN mkdir -p /var/log/supervisor /run/nginx

EXPOSE 8080

CMD ["/usr/bin/supervisord", "-c", "/etc/supervisord.conf"]

# ============================================
# Stage 4: Frontend Runtime
# ============================================
FROM nginx:alpine AS frontend

COPY apps/web/docker/nginx/nginx.conf /etc/nginx/nginx.conf
COPY apps/web/docker/nginx/default.conf /etc/nginx/conf.d/default.conf
COPY --from=frontend-builder /app/dist /usr/share/nginx/html

RUN chown -R nginx:nginx /usr/share/nginx/html

EXPOSE 8080

CMD ["nginx", "-g", "daemon off;"]

# ============================================
# Final Stage Selection
# ============================================
FROM ${SERVICE_NAME}
```

**1.3. Actualizar Nginx para Railway**

Railway usa puerto 8080 (no 80):

```bash
# Editar apps/api_php/docker/nginx/default.conf
nano apps/api_php/docker/nginx/default.conf
```

Cambiar:
```nginx
listen 80;
```
Por:
```nginx
listen 8080;
```

Lo mismo para frontend:
```bash
nano apps/web/docker/nginx/default.conf
```

**1.4. Commit cambios**

```bash
git add .
git commit -m "feat: add Railway deployment config"
git push origin main
```

---

## üöÄ Deployment Paso a Paso

### Paso 1: Crear Proyecto en Railway

1. **Ir a Railway**
   ```
   https://railway.app
   ```

2. **New Project**
   - Click en "New Project"
   - Seleccionar "Deploy from GitHub repo"
   - Autorizar Railway en GitHub
   - Seleccionar repositorio: `Arconte`
   - Branch: `main`

### Paso 2: Crear Base de Datos PostgreSQL

1. **Add Service ‚Üí Database**
   - Seleccionar "PostgreSQL"
   - Railway lo provisionar√° autom√°ticamente
   - **Nombre:** `arconte-db`

2. **Copiar Variables**
   - Railway auto-genera:
     - `DATABASE_URL`
     - `POSTGRES_USER`
     - `POSTGRES_PASSWORD`
     - `POSTGRES_DB`

### Paso 3: Agregar Redis (Opcional)

1. **Add Service ‚Üí Database**
   - Seleccionar "Redis"
   - **Nombre:** `arconte-redis`

2. **Copiar Variables**
   - `REDIS_URL`

### Paso 4: Crear Servicio de Backend

1. **Add Service ‚Üí GitHub Repo**
   - Seleccionar mismo repo
   - **Service Name:** `api`

2. **Configurar Build**
   - Settings ‚Üí Build
   - Builder: `DOCKERFILE`
   - Dockerfile Path: `Dockerfile.railway`
   - Build Arguments:
     ```
     SERVICE_NAME=backend
     ```

3. **Configurar Variables de Entorno**

   Settings ‚Üí Variables

   **Aplicaci√≥n:**
   ```
   APP_NAME=Arconte
   APP_ENV=production
   APP_DEBUG=false
   APP_URL=https://api-production-xxxx.up.railway.app
   APP_KEY=base64:XXXXXX  # Generar localmente
   ```

   **Base de Datos:**
   ```
   DB_CONNECTION=pgsql
   DB_HOST=${{Postgres.PGHOST}}
   DB_PORT=${{Postgres.PGPORT}}
   DB_DATABASE=${{Postgres.PGDATABASE}}
   DB_USERNAME=${{Postgres.PGUSER}}
   DB_PASSWORD=${{Postgres.PGPASSWORD}}
   ```

   **Redis:**
   ```
   REDIS_HOST=${{Redis.REDIS_HOST}}
   REDIS_PORT=${{Redis.REDIS_PORT}}
   REDIS_PASSWORD=${{Redis.REDIS_PASSWORD}}
   CACHE_DRIVER=redis
   SESSION_DRIVER=redis
   QUEUE_CONNECTION=redis
   ```

   **Email:**
   ```
   MAIL_MAILER=smtp
   MAIL_HOST=smtp.resend.com
   MAIL_PORT=587
   MAIL_USERNAME=resend
   MAIL_PASSWORD=re_XXXXXXXXX  # Tu API key
   MAIL_ENCRYPTION=tls
   MAIL_FROM_ADDRESS=noreply@arconte.com
   MAIL_FROM_NAME=Arconte
   ```

   **APIs:**
   ```
   GEMINI_API_KEY=XXXXXXXXXXX
   EPAYCO_PUBLIC_KEY=XXXXXXXXXXX
   EPAYCO_PRIVATE_KEY=XXXXXXXXXXX
   EPAYCO_TEST=false
   ```

   **Seguridad:**
   ```
   SANCTUM_STATEFUL_DOMAINS=arconte.com,www.arconte.com
   SESSION_SECURE_COOKIE=true
   TRUSTED_PROXIES=*
   ```

4. **Deploy**
   - Railway autom√°ticamente hace build y deploy
   - Ver logs en "Deployments"

### Paso 5: Crear Servicio de Frontend

1. **Add Service ‚Üí GitHub Repo**
   - Mismo repo
   - **Service Name:** `web`

2. **Configurar Build**
   - Settings ‚Üí Build
   - Builder: `DOCKERFILE`
   - Dockerfile Path: `Dockerfile.railway`
   - Build Arguments:
     ```
     SERVICE_NAME=frontend
     ```

3. **Configurar Variables**
   ```
   VITE_API_URL=https://api-production-xxxx.up.railway.app
   ```

4. **Deploy**

### Paso 6: Ejecutar Migraciones

Railway no tiene terminal interactivo directo, as√≠ que usamos una soluci√≥n alternativa:

**Opci√≥n A: Railway CLI**

```bash
# Instalar Railway CLI
npm install -g @railway/cli

# Login
railway login

# Conectar al proyecto
railway link

# Ejecutar comando
railway run --service api php artisan migrate --force
```

**Opci√≥n B: Script de inicio**

Agregar a `apps/api_php/docker/startup.sh`:

```bash
#!/bin/sh
php artisan migrate --force
php artisan config:cache
php artisan route:cache
php artisan view:cache

exec /usr/bin/supervisord -c /etc/supervisord.conf
```

Modificar Dockerfile.railway:
```dockerfile
COPY apps/api_php/docker/startup.sh /startup.sh
RUN chmod +x /startup.sh
CMD ["/startup.sh"]
```

### Paso 7: Configurar Dominio Personalizado

1. **En Railway ‚Üí Settings ‚Üí Domains**
   - Click "Generate Domain" (para testing)
   - O "Custom Domain"

2. **Agregar Dominio Personalizado**
   - Dominio: `arconte.com` (frontend)
   - Dominio: `api.arconte.com` (backend)

3. **En Cloudflare (tu DNS)**
   ```
   Type: CNAME
   Name: @
   Target: web-production-xxxx.up.railway.app
   Proxy: Off (importante para Railway)

   Type: CNAME
   Name: api
   Target: api-production-xxxx.up.railway.app
   Proxy: Off
   ```

4. **Esperar verificaci√≥n**
   - Railway verificar√° el dominio
   - SSL se configura autom√°ticamente

### Paso 8: Actualizar Variables con Dominio Real

```
APP_URL=https://api.arconte.com
FRONTEND_URL=https://arconte.com
SANCTUM_STATEFUL_DOMAINS=arconte.com,www.arconte.com
```

Redeploy autom√°tico se ejecuta.

---

## ‚öôÔ∏è Configuraci√≥n Avanzada

### Health Checks

Railway ‚Üí Settings ‚Üí Health Check:

```
Path: /health
Port: 8080
Timeout: 10
Interval: 30
```

### Auto-Scaling

Settings ‚Üí Resources:
```
Min Replicas: 1
Max Replicas: 3
CPU Threshold: 80%
Memory Threshold: 80%
```

### Backups

PostgreSQL backups autom√°ticos incluidos:
- Retenci√≥n: 7 d√≠as (plan Hobby)
- Retenci√≥n: 30 d√≠as (plan Pro)

Para backup manual:
```bash
railway run --service postgres pg_dump > backup.sql
```

### Logs

Ver logs en tiempo real:
```bash
railway logs --service api
```

---

## üêõ Troubleshooting

### Error: "Build failed"

**Soluci√≥n:**
```bash
# Verificar logs de build
railway logs --service api

# Com√∫n: falta de memoria
Settings ‚Üí Resources ‚Üí Increase Memory
```

### Error: "Database connection failed"

**Soluci√≥n:**
```bash
# Verificar variables
railway variables --service api | grep DB_

# Verificar que PostgreSQL est√© running
railway status
```

### Error: "502 Bad Gateway"

**Soluci√≥n:**
- Verificar que el puerto sea 8080
- Verificar health check path
- Ver logs: `railway logs`

### Migraciones no se ejecutan

**Soluci√≥n:**
```bash
# Ejecutar manualmente
railway run --service api php artisan migrate --force

# O usar startup script (ver Paso 6)
```

---

## üìä Monitoring

### M√©tricas Disponibles

Railway Dashboard muestra:
- CPU usage
- Memory usage
- Network traffic
- Request count
- Error rate

### Uptime Monitoring

Configurar servicio externo:
- UptimeRobot: https://uptimerobot.com
- URL: https://arconte.com/health
- Interval: 5 minutes

---

## üí∞ Optimizaci√≥n de Costos

### Tips para Reducir Costos

1. **Usar 1 instancia** (no auto-scale si no es necesario)
2. **Reducir recursos** del frontend (poco uso de CPU)
3. **PostgreSQL compartido** (suficiente para empezar)
4. **Deshabilitar servicios** en staging cuando no se usen

### Proyecci√≥n de Costos

**M√≠nimo viable:**
- PostgreSQL Hobby: $5
- Redis (opcional): $5
- API (512MB): $10
- Frontend (256MB): $5
- **Total:** $25/mes

**Producci√≥n media:**
- PostgreSQL Pro: $10
- Redis: $5
- API (1GB): $20
- Frontend (512MB): $10
- **Total:** $45/mes

---

## üîÑ CI/CD

Railway configura CI/CD autom√°ticamente:

```
1. Push a GitHub (main branch)
   ‚Üì
2. Railway detecta cambio
   ‚Üì
3. Build autom√°tico
   ‚Üì
4. Deploy autom√°tico
   ‚Üì
5. Health check
   ‚Üì
6. Live ‚úÖ
```

### Deploy Preview (Branches)

Railway puede crear deploys de preview para PRs:

Settings ‚Üí Environment ‚Üí PR Deploys: Enable

---

## ‚úÖ Checklist Railway

- [ ] Cuenta Railway creada
- [ ] Repositorio conectado
- [ ] PostgreSQL provisionado
- [ ] Redis provisionado (opcional)
- [ ] Variables de entorno configuradas
- [ ] Backend deployed
- [ ] Frontend deployed
- [ ] Migraciones ejecutadas
- [ ] Dominio personalizado configurado
- [ ] SSL verificado
- [ ] Health checks funcionando
- [ ] Logs monitoreados
- [ ] Backups verificados

---

## üÜö Railway vs VPS

| Caracter√≠stica | Railway | VPS |
|---------------|---------|-----|
| Setup time | 15 min | 2 horas |
| DevOps skills | No requiere | Requiere |
| Costo | $25-45/mes | $5-20/mes |
| SSL | Autom√°tico | Manual |
| Backups | Incluidos | Manual |
| Scaling | Autom√°tico | Manual |
| Control | Limitado | Total |

**Cu√°ndo usar Railway:**
- ‚úÖ MVP o startup
- ‚úÖ Equipo peque√±o
- ‚úÖ Sin DevOps en equipo
- ‚úÖ Necesitas deploy r√°pido

**Cu√°ndo usar VPS:**
- ‚úÖ Control total necesario
- ‚úÖ Presupuesto ajustado
- ‚úÖ Tr√°fico alto
- ‚úÖ Tienes DevOps skills

---

## üìö Recursos

**Railway:**
- Docs: https://docs.railway.app
- Discord: https://discord.gg/railway
- Status: https://status.railway.app

**Alternativas PaaS:**
- Render: https://render.com
- Fly.io: https://fly.io
- Heroku: https://heroku.com (m√°s caro)

---

**¬øListo para deploy?** üöÄ

```bash
railway login
railway init
railway up
```

¬°Tu app estar√° live en minutos!
